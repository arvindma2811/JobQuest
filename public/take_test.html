<!DOCTYPE html>
<html>
<head>
  <title>Take Test</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="css/styles.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237F00FF'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eâš™%3C/text%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

</head>

<script>
  // === Fetch logged-in user info for navbar ===
  fetch('/profile')
    .then(res => {
      if (!res.ok) throw new Error('Not logged in');
      return res.json();
    })
    .then(user => {
      const navName = document.querySelector('.profile-text');
      const navPic = document.querySelector('.profile-pic');
      if (navName) navName.textContent = user.username;
      if (navPic) navPic.src = user.profile_pic || 'images/Pfp.jpeg';
    })
    .catch(() => {
      window.location.href = 'login.html';
    });

  // === Logout function ===
  function logout() {
    fetch('/logout').then(() => {
      window.location.href = 'login.html';
    });
  }
</script>

<body>
  <nav class="navbar">
    <div class="logo">
      <img src="images/logo.png" alt="Logo">
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li class="dropdown">
        <a href="#services">Services</a>
        <ul class="dropdown-content">
          <li><a href="video.html">Videos</a></li>
          <li><a href="tests.html">Tests</a></li>
        </ul>
      </li>
      <li><a href="analysis.html">Analysis</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li class="profile dropdown">
        <a href="#profile">
          <img class="profile-pic" src="images/Pfp.jpeg" alt="Profile picture">
          <span class="profile-text">Profile</span>
        </a>
        <ul class="dropdown-content">
          <li><a href="profile.html">View Profile</a></li>
          <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <main class="main-content">
    <div id="questions"></div>
    <div class="submit-section">
      <button class="submit-btn" onclick="submitAnswers()">Submit All Answers</button>
    </div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const test_id = urlParams.get("test_id");

let questions = [];
let answers = {};
let currentUser = null;

// Fetch user data first
fetch('/profile')
  .then(res => {
    if (!res.ok) throw new Error('Not logged in');
    return res.json();
  })
  .then(user => {
    currentUser = user;
    return fetch(`/tests/${test_id}/questions`);
  })
  .then(res => {
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    return res.json();
  })
  .then(data => {
    questions = data;
    renderQuestions();
  })
  .catch(err => {
    console.error('Error loading test:', err);
    document.getElementById("questions").innerHTML = `<div style="color: white; text-align: center; padding: 2rem;"><p>Failed to load questions! ${err.message}</p><p>Test ID: ${test_id}</p></div>`;
  });

function renderQuestions() {
  let html = "";
  questions.forEach((q, index) => {
    html += `<div class="question">
      <div class="question-header">
        <span class="question-number">${index + 1}</span>
        <h3>${q.question_text}</h3>
        <span class="question-type-badge">${q.type.toUpperCase()}</span>
      </div>
      <div class="answer-section">
    `;

    if (q.type === "mcq") {
      html += `
        <div class="mcq-options">
          <label class="option-label">
            <input type="radio" name="q${q.id}" value="A">
            <span>${q.option_a}</span>
          </label>
          <label class="option-label">
            <input type="radio" name="q${q.id}" value="B">
            <span>${q.option_b}</span>
          </label>
          <label class="option-label">
            <input type="radio" name="q${q.id}" value="C">
            <span>${q.option_c}</span>
          </label>
          <label class="option-label">
            <input type="radio" name="q${q.id}" value="D">
            <span>${q.option_d}</span>
          </label>
        </div>
      `;
    }
    else if (q.type === "text") {
    html += `
    <textarea class="text-answer" id="q${q.id}" placeholder="Write your answer here..."></textarea>
    <button type="button" class="voice-btn" data-qid="${q.id}">ðŸŽ¤ Speak</button>`;
    }

  
    html += `</div></div>`;
  });

  document.getElementById("questions").innerHTML = html;
}

// ==================== SUBMIT ANSWERS ====================
async function submitAnswers() {
  const btn = event.target;
  
  // Validate that user is logged in
  if (!currentUser || !currentUser.id) {
    alert('Error: User not authenticated. Please log in again.');
    return;
  }

  // Check if any answer is provided
  let hasAnswers = false;
  for (const q of questions) {
    if (q.type === "mcq") {
      const value = document.querySelector(`input[name="q${q.id}"]:checked`);
      if (value) {
        hasAnswers = true;
        break;
      }
    } else if (q.type === "text") {
      const text = document.getElementById(`q${q.id}`).value.trim();
      if (text) {
        hasAnswers = true;
        break;
      }
    }
  }

  if (!hasAnswers) {
    alert('Please answer at least one question before submitting.');
    return;
  }

  btn.disabled = true;
  btn.classList.add('loading');
  btn.textContent = 'Submitting...';

  try {
    // Submit all answers
    for (const q of questions) {
      if (q.type === "mcq") {
        const value = document.querySelector(`input[name="q${q.id}"]:checked`);
        if (value) {
          await fetch("/tests/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: currentUser.id,
              test_id,
              question_id: q.id,
              answer_text: value.value,
              is_mcq: true
            })
          }).then(r => {
            if (!r.ok) throw new Error('Failed to submit MCQ answer');
            return r.json();
          });
        }
      }
      else if (q.type === "text") {
        const text = document.getElementById(`q${q.id}`).value;
        if (text.trim()) {
          await fetch("/tests/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: currentUser.id,
              test_id,
              question_id: q.id,
              answer_text: text,
              is_mcq: false
            })
          }).then(r => {
            if (!r.ok) throw new Error('Failed to submit text answer');
            return r.json();
          });
        }
      }
    }

    btn.classList.remove('loading');
    btn.textContent = 'Calculating Score...';

    // Calculate score
    const scoreData = await calculateTestScore();
    
    if (scoreData) {
      btn.textContent = `âœ“ Score: ${scoreData.percentage}%`;
      setTimeout(() => {
        alert(`Test completed!\n\nYour Score: ${scoreData.percentage}%\nCorrect Answers: ${scoreData.correctAnswers}/${scoreData.totalQuestions}`);
        window.location.href = 'tests.html';
      }, 1500);
    } else {
      btn.textContent = 'âœ“ Submitted Successfully!';
      setTimeout(() => {
        alert("Test submitted successfully!");
        window.location.href = 'tests.html';
      }, 1500);
    }
  } catch (error) {
    console.error('Submission error:', error);
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'Submit All Answers';
    alert('Error submitting test. Please try again.');
  }
}

// ==================== CALCULATE SCORE ====================
async function calculateTestScore() {
  try {
    const response = await fetch("/tests/calculate-score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: currentUser.id,
        test_id
      })
    });

    if (!response.ok) throw new Error('Failed to calculate score');
    
    const scoreData = await response.json();
    
    console.log(`âœ… Score calculated: ${scoreData.percentage}%`);
    return scoreData;
  } catch (error) {
    console.error('Score calculation error:', error);
    return null;
  }
}
</script>

  </main>

<script>
/* ==================== VOICE INPUT (SAFE ADDITION) ==================== */

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  let activeQuestionId = null;

  // Delegate click handling (important because buttons are dynamic)
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("voice-btn")) {
      activeQuestionId = e.target.getAttribute("data-qid");
      recognition.start();
    }
  });

  recognition.onresult = (event) => {
    const spokenText = event.results[0][0].transcript;
    if (activeQuestionId) {
      const textarea = document.getElementById(`q${activeQuestionId}`);
      if (textarea) textarea.value = spokenText;
    }
  };

  recognition.onerror = (err) => {
    console.error("Voice input error:", err);
    alert("Voice recognition failed. Please try again.");
  };
} else {
  console.warn("Speech Recognition not supported");
}
</script>


</body>
</html>
